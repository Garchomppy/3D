<!DOCTYPE html>
<html lang="vi">
  <head>
    <title>Thành cổ Quảng Trị - Xem 3D với ảnh tùy chỉnh</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Cesium.js"></script>
    <link
      href="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Widgets/widgets.css"
      rel="stylesheet"
    />
    <style>
      html,
      body,
      #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
      }
      h2 {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        z-index: 100;
        margin: 0;
        padding: 10px;
        background: rgba(0, 0, 0, 0.5);
      }
      #status {
        position: absolute;
        bottom: 10px;
        left: 10px;
        color: yellow;
        z-index: 100;
        font-size: 12px;
        background: rgba(0, 0, 0, 0.5);
        padding: 5px;
      }
    </style>
  </head>
  <body>
    <h2>Bản đồ 3D Thành cổ Quảng Trị</h2>
    <div id="status">Đang load...</div>
    <div id="cesiumContainer"></div>
    <script>
      Cesium.Ion.defaultAccessToken =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwMDM5ODA1Zi01MTIzLTQ3MjQtYmM4MC1jNTljNTg3NzY5ODMiLCJpZCI6MzUwMzQxLCJpYXQiOjE3NjA0MzM0NDd9.8ukepDApCn590T0jpZsLhEpSSueRuu2XszygjoYkl7A";

      async function initViewer() {
        let terrainProvider = undefined;
        const statusEl = document.getElementById("status");

        try {
          if (Cesium.Ion.defaultAccessToken) {
            statusEl.textContent = "Đang load địa hình 3D...";
            terrainProvider = await Cesium.createWorldTerrainAsync({
              requestWaterMask: true,
              requestVertexNormals: true,
            });
            statusEl.textContent =
              "Đã load thành công! Đang thử load ảnh local...";
          } else {
            statusEl.textContent = "Chế độ flat - thêm token cho terrain.";
          }
        } catch (error) {
          console.error("Lỗi load terrain:", error);
          statusEl.textContent = "Lỗi token: Chạy flat.";
        }

        const viewer = new Cesium.Viewer("cesiumContainer", {
          terrainProvider: terrainProvider,
          baseLayerPicker: false,
          geocoder: true,
          homeButton: true,
          sceneModePicker: true,
          navigationHelpButton: true,
          animation: false,
          timeline: false,
          fullscreenButton: true,
          sceneMode: Cesium.SceneMode.SCENE3D,
        });

        // THÊM ẢNH LOCAL (test trong folder)
        async function addCustomImage() {
          const imageUrl = "images/T7M_9205.jpg"; // Relative path cho local
          try {
            const rectangle = Cesium.Rectangle.fromDegrees(
              107.185, // west (chỉnh nếu ảnh lệch)
              16.748, // south
              107.191, // east
              16.753 // north
            );
            const customLayer = await Cesium.ImageryLayer.fromProviderAsync(
              new Cesium.SingleTileImageryProvider({
                url: imageUrl,
                rectangle: rectangle,
                credit: "Ảnh tùy chỉnh", // Tùy chọn: credit hiển thị
              })
            );
            viewer.imageryLayers.add(customLayer, 0); // Phủ lên base map
            statusEl.textContent +=
              " | Ảnh local đã load! Zoom vào vùng để xem.";
            console.log("Ảnh load OK:", imageUrl);
          } catch (error) {
            console.error("Lỗi load ảnh local:", error);
            statusEl.textContent +=
              " | Lỗi ảnh: Kiểm tra đường dẫn/folder hoặc CORS. Upload public thử nhé!";
          }
        }
        addCustomImage(); // Gọi load ảnh

        // Zoom + tilt 3D (zoom sát hơn để thấy ảnh nếu bounds đúng)
        const quangTri = Cesium.Cartesian3.fromDegrees(107.188, 16.7505, 200); // Thấp hơn để gần vùng ảnh
        viewer.camera.setView({
          destination: quangTri,
          orientation: {
            heading: 0,
            pitch: -0.785, // Tilt mạnh
            roll: 0,
          },
        });

        // Marker
        viewer.entities.add({
          position: Cesium.Cartesian3.fromDegrees(107.188, 16.7505, 10),
          point: {
            pixelSize: 10,
            color: Cesium.Color.RED,
            outlineColor: Cesium.Color.WHITE,
            outlineWidth: 2,
          },
          label: {
            text: "Thành cổ Quảng Trị",
            font: "14pt monospace",
            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
            outlineWidth: 2,
            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
            pixelOffset: new Cesium.Cartesian2(0, -10),
          },
        });

        setTimeout(() => {
          statusEl.style.display = "none";
        }, 5000);
      }

      initViewer();
    </script>
  </body>
</html>
